# GitLab CI/CD configuration for GlobtimPostProcessing.jl

stages:
  - check
  - test
  - coverage

variables:
  JULIA_DEPOT_PATH: "$CI_PROJECT_DIR/.julia"
  JULIA_NUM_THREADS: "4"

# Check runner environment
check-environment:
  stage: check
  script:
    - echo "=== System Information ==="
    - uname -a
    - echo "=== Check for Julia ==="
    - which julia && julia --version || echo "Julia not found"
    - echo "=== Attempting to install Julia via juliaup ==="
    - curl -fsSL https://install.julialang.org | sh -s -- -y || echo "juliaup installation failed"
    - export PATH="$HOME/.juliaup/bin:$PATH"
    - which julia && julia --version || echo "Julia still not found after juliaup"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'

# Syntax check
syntax-check:
  stage: check
  before_script:
    - curl -fsSL https://install.julialang.org | sh -s -- -y
    - export PATH="$HOME/.juliaup/bin:$PATH"
    - juliaup add 1.11
    - juliaup default 1.11
  script:
    - export PATH="$HOME/.juliaup/bin:$PATH"
    - julia --version
    - find src -name "*.jl" -exec julia --check-bounds=yes -e 'include("{}")' \;
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
  allow_failure: true

# Test job for Julia 1.11
test:julia-1.11:
  stage: test
  before_script:
    - echo "Installing Julia via juliaup..."
    - curl -fsSL https://install.julialang.org | sh -s -- -y
    - export PATH="$HOME/.juliaup/bin:$PATH"
    - juliaup add 1.11
    - juliaup default 1.11
  cache:
    key: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"
    paths:
      - .julia/
      - $HOME/.juliaup/
  script:
    - export PATH="$HOME/.juliaup/bin:$PATH"
    - julia --version
    - julia --project=@. -e 'using Pkg; Pkg.instantiate(); Pkg.resolve()'
    - julia --project=@. -e 'using Pkg; Pkg.test(coverage=true)'
  coverage: '/Test coverage (\d+\.\d+)%/'
  artifacts:
    when: always
    paths:
      - .julia/logs
      - "**/*.cov"
    expire_in: 1 week
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'

# Test on Julia 1.10 for compatibility
test:julia-1.10:
  stage: test
  before_script:
    - curl -fsSL https://install.julialang.org | sh -s -- -y
    - export PATH="$HOME/.juliaup/bin:$PATH"
    - juliaup add 1.10
    - juliaup default 1.10
  cache:
    key: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"
    paths:
      - .julia/
      - $HOME/.juliaup/
  script:
    - export PATH="$HOME/.juliaup/bin:$PATH"
    - julia --version
    - julia --project=@. -e 'using Pkg; Pkg.instantiate(); Pkg.resolve()'
    - julia --project=@. -e 'using Pkg; Pkg.test()'
  allow_failure: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'

# Coverage analysis
coverage:
  stage: coverage
  before_script:
    - curl -fsSL https://install.julialang.org | sh -s -- -y
    - export PATH="$HOME/.juliaup/bin:$PATH"
    - juliaup add 1.11
    - juliaup default 1.11
  dependencies:
    - test:julia-1.11
  cache:
    key: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"
    paths:
      - .julia/
      - $HOME/.juliaup/
  script:
    - export PATH="$HOME/.juliaup/bin:$PATH"
    - julia --version
    - julia --project=@. -e 'using Pkg; Pkg.add("Coverage"); Pkg.instantiate()'
    - |
      julia --project=@. -e '
        using Coverage
        coverage = process_folder("src")
        covered_lines, total_lines = get_summary(coverage)
        percentage = round(100 * covered_lines / total_lines; digits=2)
        println("Test coverage $(percentage)%")
        LCOV.writefile("coverage.lcov", coverage)
      '
  coverage: '/Test coverage (\d+\.\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.lcov
    paths:
      - coverage.lcov
    expire_in: 1 week
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
